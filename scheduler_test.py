import os
import numpy as np

import tensorflow as tf
import tensorflow.keras.backend as K

import matplotlib.pyplot as plt


def _scheduler(step):
    step = step + 1
    arg1 = K.eval(tf.math.rsqrt(np.float32(step)))
    arg2 = step * ((500 / 12) ** -1.5)
    r = K.eval(tf.math.rsqrt(np.float32(4096))) * min(arg1, arg2)
    #print(step, '\t', arg1, '\t', arg2, '\t', r)
    return r


def warmup_cosine_decay(lr=0.1, epochs=500, warmup=10):
    def func(epoch):
        if epoch <= warmup:
            return lr * (epoch / warmup) ** 2
        else:
            return lr * 0.5 * (1 + np.cos(np.pi * (epoch - warmup) / np.float32(epochs - warmup)))
    return func


if __name__ == '__main__':
    x = np.array([i for i in range(500)])
    origin = np.array([_scheduler(x) for x in range(500)])
    func = warmup_cosine_decay(0.001, 500, 10)
    cos = np.array([func(x) for x in range(500)])
    func2 = warmup_cosine_decay(0.003, 500, 10)
    cos2 = np.array([func2(x) for x in range(500)])

    
    plt.plot(x, origin, label='origin decay')
    plt.plot(x, cos, label='cos decay (0.001)')
    plt.plot(x, cos2, label='cos decay (0.003)')

    plt.legend()
    plt.savefig('decay.png', dpi=300)
    plt.close()



'''
1        1.0     0.0037180640123591203   5.8094750193111255e-05
2        0.70710677      0.007436128024718241    0.00011618950038622251
3        0.57735026      0.01115419203707736     0.00017428425057933376
4        0.5     0.014872256049436481    0.00023237900077244502
5        0.4472136       0.0185903200617956      0.00029047375096555626
6        0.40824828      0.02230838407415472     0.0003485685011586675
7        0.3779645       0.026026448086513842    0.0004066632513517788
8        0.35355338      0.029744512098872963    0.00046475800154489004
9        0.33333334      0.03346257611123208     0.0005228527517380012
10       0.31622776      0.0371806401235912      0.0005809475019311125
11       0.30151135      0.04089870413595032     0.0006390422521242238
12       0.28867513      0.04461676814830944     0.000697137002317335
13       0.2773501       0.04833483216066856     0.0007552317525104463
14       0.26726124      0.052052896173027684    0.0008133265027035576
15       0.2581989       0.055770960185386804    0.0008714212528966688
16       0.25    0.059489024197745925    0.0009295160030897801
17       0.24253564      0.06320708821010504     0.0009876107532828912
18       0.23570228      0.06692515222246416     0.0010457055034760025
19       0.22941573      0.07064321623482328     0.0011038002536691138
20       0.2236068       0.0743612802471824      0.001161895003862225
21       0.21821788      0.07807934425954152     0.0012199897540553363
22       0.21320072      0.08179740827190064     0.0012780845042484475
23       0.2085144       0.08551547228425976     0.0013361792544415588
24       0.20412414      0.08923353629661888     0.00139427400463467
25       0.2     0.092951600308978       0.0014523687548277813
26       0.19611613      0.09666966432133713     0.0015104635050208926
27       0.19245009      0.10038772833369625     0.0015685582552140039
28       0.18898225      0.10410579234605537     0.0016266530054071151
29       0.18569534      0.10782385635841449     0.0016847477556002264
30       0.18257418      0.11154192037077361     0.0017428425057933376
31       0.1796053       0.11525998438313273     0.001800937255986449
32       0.17677669      0.11897804839549185     0.0018590320061795602
33       0.17407766      0.12269611240785097     0.0019171267563726714
34       0.1714986       0.12641417642021008     0.0019752215065657825
35       0.16903085      0.1301322404325692      0.002033316256758894
36       0.16666667      0.13385030444492832     0.002091411006952005
37       0.16439898      0.13756836845728745     0.0021495057571451165
38       0.16222142      0.14128643246964656     0.0022076005073382275
39       0.16012816      0.1450044964820057      0.002265695257531339
40       0.15811388      0.1487225604943648      0.00232379000772445
41       0.15617377      0.15244062450672394     0.0023818847579175615
42       0.15430336      0.15615868851908304     0.00241099
43       0.15249857      0.15987675253144218     0.0023827902
44       0.15075567      0.16359481654380129     0.0023555574
45       0.1490712       0.16731288055616042     0.0023292375
46       0.14744195      0.17103094456851953     0.0023037805
47       0.145865        0.17474900858087866     0.0022791405
48       0.14433756      0.17846707259323777     0.0022552744
49       0.14285715      0.1821851366055969      0.002232143
50       0.14142136      0.185903200617956       0.0022097088
51       0.14002801      0.18962126463031515     0.0021879377
52       0.13867505      0.19333932864267425     0.0021667976
53       0.13736056      0.1970573926550334      0.0021462587
54       0.13608277      0.2007754566673925      0.0021262933
55       0.13483998      0.20449352067975163     0.0021068747
56       0.13363062      0.20821158469211073     0.0020879784
57       0.13245323      0.21192964870446987     0.0020695818
58       0.13130642      0.21564771271682898     0.002051663
59       0.13018891      0.2193657767291881      0.0020342018
60       0.12909944      0.22308384074154722     0.0020171788
61       0.12803687      0.22680190475390635     0.0020005761
62       0.12700012      0.23051996876626546     0.001984377
63       0.12598816      0.2342380327786246      0.001968565
64       0.125   0.2379560967909837      0.001953125
65       0.12403473      0.2416741608033428      0.0019380427
66       0.12309149      0.24539222481570194     0.0019233045
67       0.12216945      0.24911028882806105     0.0019088977
68       0.12126782      0.25282835284042016     0.0018948097
69       0.120385855     0.2565464168527793      0.001881029
70       0.11952286      0.2602644808651384      0.0018675447
71       0.118678175     0.26398254487749756     0.0018543465
72       0.11785114      0.26770060888985664     0.001841424
73       0.11704115      0.2714186729022158      0.0018287679
74       0.11624764      0.2751367369145749      0.0018163694
75       0.115470044     0.27885480092693404     0.0018042194
76       0.114707865     0.2825728649392931      0.0017923104
77       0.11396058      0.28629092895165226     0.001780634
78       0.11322771      0.2900089929640114      0.001769183
79       0.112508796     0.2937270569763705      0.0017579499
80       0.1118034       0.2974451209887296      0.0017469281
81       0.11111111      0.30116318500108874     0.0017361111
82       0.11043152      0.3048812490134479      0.0017254925
83       0.10976426      0.308599313025807       0.0017150666
84       0.10910894      0.3123173770381661      0.0017048272
85       0.10846523      0.3160354410505252      0.0016947692
86       0.107832775     0.31975350506288436     0.0016848871
87       0.107211255     0.3234715690752435      0.0016751759
88       0.10660036      0.32718963308760257     0.0016656306
89       0.10599979      0.3309076970999617      0.0016562467
90       0.10540926      0.33462576111232084     0.0016470196
91       0.10482848      0.33834382512468        0.001637945
92       0.1042572       0.34206188913703905     0.0016290188
93       0.10369517      0.3457799531493982      0.001620237
94       0.10314212      0.3494980171617573      0.0016115956
95       0.10259783      0.35321608117411646     0.0016030911
96       0.10206207      0.35693414518647554     0.0015947198
97       0.10153461      0.3606522091988347      0.0015864783
98       0.101015255     0.3643702732111938      0.0015783634
99       0.10050379      0.3680883372235529      0.0015703717
100      0.1     0.371806401235912       0.0015625
'''